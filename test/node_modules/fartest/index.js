/*-------------------------------------
       FAst and smaRT TESTing
	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
	Very small handmade library for
	easy and fast testing.
--------------------------------------*/

const chalk = require('chalk')

if (!chalk)
	throw '`npm install` is necessary'


let
	currentStage = '',
	errorOccured = false,
	stageError = false,
	runningTest = false,
	testQueue = []


function happy() {
	const emojis = ['😏', '😄', '😃', '😉', '😊', '😋', '😌']
	return emojis[Math.floor(Math.random() * emojis.length)]
}

function sad() {
	const emojis = ['😓', '😢', '😞', '😩', '😫']
	return emojis[Math.floor(Math.random() * emojis.length)]
}

async function starTest(testFunction) {
	if (runningTest)
		return testQueue.push(testFunction)
	runningTest = true

	let {name} = testFunction
	if (name) {
		console.log(chalk.bold.blue("🢚 "+name))
		name += ' '
	}

	try {
		await testFunction()
		endStage()

		if (errorOccured)
			console.log(chalk.bold.yellow(`An error occured during the test ${name}${sad()}\n`))
		else
			console.log(chalk.bold.green(`The test ${name}has been successfully passed ${happy()}\n`))
	}
	catch (error) {
		console.log(chalk.bold.red(`✗ ${currentStage} : a critical error occured ${sad()} :`))
		if (typeof error == 'object' && error instanceof Error) {
			console.log(error.message)
			if (error.code)
				console.log("Code error "+ error.code)
			if (error.stdout)
				console.log(error.stdout)
			if (error.stderr)
				console.log(error.stderr)
		}
		else
			console.log(error)
		console.log()
	}

	// next test function
	const next = testQueue.shift()
	currentStage = ''
	errorOccured = false
	stageError = false
	runningTest = false

	if (next)
		starTest(next)
}

function stage(newStage) {
	endStage()
	currentStage = newStage
}

function endStage() {
	if (!currentStage)
		return
	if (stageError) {
		console.log(chalk.bold.red("✗ "+currentStage))
		stageError = false
	}
	else
		console.log(chalk.green("✓ "+currentStage))
}

function test(conditionA, conditionB) {
	switch (arguments.length) {
		case 1:
			if (conditionA)
				return
			break
		case 2:
			if (conditionA === conditionB)
				return
			break
		default:
			throw "Bad use of function FarTest.test(). One or two arguments are expected."
	}

	stageError = true
	errorOccured = true
}


module.exports = {
	starTest,
	stage,
	test,
}